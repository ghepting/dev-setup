#!/usr/bin/env zsh

ZSHRC_FILE="$HOME/.zshrc"

# colors
RED="\e[31m"
GREEN="\e[32m"
YELLOW="\e[33m"
BLUE="\e[34m"
MAGENTA="\e[35m"
CYAN="\e[36m"
WHITE="\e[37m"
GRAY="\e[38m"
NC="\e[0m" # No Color (Reset)

# prompt for confirmation before continuing
echo -e "${YELLOW}WARNING: This script will completely uninstall the tools and configurations installed by the dev setup and is not perfect... I trust you know what you're doing!${NC}"
echo -e "${RED}You have been warned!${NC}"
read -k 1 -r "REPLY?Are you sure you want to proceed with the uninstallation? (y/N) "
echo
if [[ ! $REPLY =~ ^[Yy]$ ]]
then
    echo -e "${BLUE}Uninstallation aborted.${NC}"
    exit 0
fi

# backup .zshrc
if [ -f "$ZSHRC_FILE" ]
then
  TIMESTAMP=$(date +%Y%m%d_%H%M%S)
  BACKUP_FILE="$ZSHRC_FILE.backup.$TIMESTAMP"
  cp "$ZSHRC_FILE" "$BACKUP_FILE"
  echo -e "${GRAY}Created backup of $ZSHRC_FILE ($BACKUP_FILE)${NC}"
fi

# uninstall all brew formulae & casks
brew uninstall --force $(brew list --formula)
brew uninstall --force $(brew list --cask)
brew cleanup --prune=all
brew autoremove

# cleanup ruby & rbenv dirs
rm -rf ~/.rbenv
rm -rf ~/Library/Caches/ruby

# cleanup python & pyenv dirs
rm -rf ~/.pyenv
rm -rf ~/Library/Caches/pip

# uninstall node & nvm
# try to load nvm to ensure npm is available
export NVM_DIR="$HOME/.nvm"
[ -s "$NVM_DIR/nvm.sh" ] && \. "$NVM_DIR/nvm.sh"

if command -v npm &> /dev/null
then
  npm uninstall -g npm
fi
# cleanup node & nvm dirs
rm -rf ~/.npm
rm -rf ~/Library/Caches/npm
rm -rf ~/Library/Caches/node-gyp
rm -rf ~/.nvm
rm -rf ~/.nodeenv

# cleanup vim & tmux configuration (leaves the .local files with any user customizations)
rm -f ~/.tmux.conf
rm -f ~/.vimrc
rm -f ~/.vimrc.bundles
rm -rf ~/.vim

# cleanup claude code cli
rm -f ~/.local/bin/claude
rm -rf ~/.claude-code

# helper function to remove multi-line blocks from .zshrc
remove_zshrc_block() {
  local content="$1"
  local name="$2"

  # Use perl for safe multi-line replacement using environment variable
  # -0777 slurps the entire file
  export BLOCK_CONTENT="$content"

  # Check if content exists before trying to remove (for reporting)
  # using perl to check match counting
  if perl -0777 -ne 'exit 1 unless /\Q$ENV{BLOCK_CONTENT}\E/' "$ZSHRC_FILE"
  then
    perl -0777 -i -pe 's/\Q$ENV{BLOCK_CONTENT}\E//g' "$ZSHRC_FILE"
    echo -e "${BLUE}Removed $name configuration from $ZSHRC_FILE${NC}"
    RESTART_REQUIRED=true
  fi
}

BREW_CONTENT=$(cat <<'EOF'
# homebrew
export PATH="$(brew --prefix)/bin:$PATH"
EOF
)

RUBY_CONTENT=$(cat <<'EOF'
# rbenv
eval "$(rbenv init -)"
EOF
)

PYENV_CONTENT=$(cat <<'EOF'
# pyenv
export PYENV_ROOT="$HOME/.pyenv"
[[ -d $PYENV_ROOT/bin ]] && export PATH="$PYENV_ROOT/bin:$PATH"
eval "$(pyenv init - zsh)"
EOF
)

NVM_CONTENT=$(cat <<'EOF'
# nvm
export NVM_DIR="$HOME/.nvm"
[ -s "$NVM_DIR/nvm.sh" ] && \. "$NVM_DIR/nvm.sh"
[ -s "$NVM_DIR/bash_completion" ] && \. "$NVM_DIR/bash_completion"
EOF
)

# remove .zshrc updates
remove_zshrc_block "$BREW_CONTENT" "homebrew"
remove_zshrc_block "$RUBY_CONTENT" "rbenv"
remove_zshrc_block "$PYENV_CONTENT" "pyenv"
remove_zshrc_block "$NVM_CONTENT" "nvm"

# uninstall Homebrew - see: https://github.com/homebrew/install#uninstall-homebrew
NONINTERACTIVE=1 /bin/bash -c "$(curl -fsSL https://raw.githubusercontent.com/Homebrew/install/HEAD/uninstall.sh)"
sudo rm -rf /usr/local/Homebrew
rm -rf /usr/local/var/homebrew
rm -rf /usr/local/Cellar
rm -rf /usr/local/Caskroom
rm -rf ~/Library/Caches/Homebrew
rm -rf /usr/local/bin/brew
rm -rf /usr/local/share/doc/homebrew
rm -rf /usr/local/share/man/man1/brew.1
rm -rf /usr/local/share/zsh/site-functions/_brew
rm -rf /usr/local/etc/bash_completion.d/brew

echo -e "${GREEN}Uninstall completed successfully. Restart your terminal.${NC}"
exit 0
