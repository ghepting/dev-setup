#!/usr/bin/env zsh

# Check if we are running in zsh or bash
if [ -z "$ZSH_VERSION" ] && [ -z "$BASH_VERSION" ]; then
  echo -e "${RED}Error: This script must be run in zsh or bash.${NC}"
  return 1
fi

ZSHRC_FILE="$HOME/.zshrc"

# colors
RED="\e[31m"
GREEN="\e[32m"
YELLOW="\e[33m"
BLUE="\e[34m"
MAGENTA="\e[35m"
CYAN="\e[36m"
WHITE="\e[37m"
NC="\e[0m" # No Color (Reset)

RESTART_REQUIRED=false

# source utility functions
source "./lib/utils.sh"
source "./lib/brew.sh"
source "./lib/ruby.sh"
source "./lib/python.sh"
source "./lib/node.sh"
source "./lib/gemini.sh"
source "./lib/vim_tmux.sh"
source "./lib/1password.sh"
source "./lib/dotfiles.sh"
source "./lib/docker.sh"
source "./lib/app_store.sh"
source "./lib/claude.sh"
source "./lib/editor.sh"
source "./lib/iterm.sh"
source "./lib/postman.sh"

echo -e "${WHITE}Detected platform: ${PLATFORM}${NC}"

CONFIG_DIR="${HOME}/.config"
CONFIG_FILE="${CONFIG_DIR}/dev-setup.conf"

# create config directory if it doesn't exist
if [ ! -d "$CONFIG_DIR" ]
then
  mkdir -p "$CONFIG_DIR"
fi

# copy config file to ~/.config/dev-setup.conf if it doesn't exist
if [ ! -f "$CONFIG_FILE" ]
then
  cp "./dev-setup.conf" "$CONFIG_FILE"
  echo -e "${GREEN}Created default configuration at $CONFIG_FILE${NC}"
fi

prompt_config() {
  echo -e "\n${WHITE}--- Configuration Review ---${NC}"
  echo -e "The setup will proceed with defaults based on your platform ($PLATFORM)."
  echo -e "Config path: ${WHITE}$CONFIG_FILE${NC}"

  echo -e "\n${WHITE}Current Toggles:${NC}"
  local modules=(
    "google_drive"
    "dotfiles"
    "vim_tmux"
    "editor"
    "op"
    "ruby"
    "python"
    "node"
    "docker"
    "app_store"
    "claude_code_cli"
    "gemini_cli"
    "postman_cli"
  )

  for module in "${modules[@]}"; do
    local module_status="${RED}disabled${NC}"
    is_enabled "$module" && module_status="${GREEN}enabled${NC}"
    printf "  %-20s : %b\n" "$module" "$module_status"
  done

  echo -n -e "\n${YELLOW}Modify configuration? [y/N]: ${NC}"
  read -r REPLY
  if [[ ! $REPLY =~ ^[Yy]$ ]]; then
    echo -e "${GREEN}Using current configuration.${NC}"
    echo -e "${YELLOW}----------------------------${NC}\n"
    return
  fi

  echo -e "\n${WHITE}Interactive Configuration (press Enter to keep default):${NC}"
  for module in "${modules[@]}"; do
    local current="n"
    is_enabled "$module" && current="y"

    echo -n -e "  Enable ${CYAN}${module}${NC}? [y/n] (default: $current): "
    read -r REPLY
    case "$REPLY" in
      [Yy]*)
        set_config_value "$module" "true"
        ;;
      [Nn]*)
        set_config_value "$module" "false"
        ;;
    esac
  done
  echo -e "\n${GREEN}Configuration updated.${NC}"
  echo -e "${YELLOW}----------------------------${NC}\n"
}

# Handle execution
if [[ "${(%):-%N}" == "$0" ]]; then
  # Run the interactive configuration
  prompt_config

  # initial setup
  if is_macos; then
    # install homebrew
    setup_homebrew
  fi

  # google drive setup
  setup_google_drive

  # configuration toggles
  if is_enabled "dotfiles"; then
    symlink_google_drive_dotfiles
    symlink_antigravity_config
  fi

  if is_macos; then
    # add homebrew to path
    install_homebrew_path

    # add ghostty to path
    install_ghostty_path

    # homebrew and formulae
    install_homebrew_formulae

    # iTerm2 colors
    setup_iterm_colors
  fi

  # configure Antigravity as default editor
  if is_enabled "editor"; then
    configure_editor
    install_antigravity_extensions
    update_antigravity_extensions_list
  fi

  # docker
  if is_enabled "docker"; then
    setup_docker
  fi

  # ruby and rbenv
  if is_enabled "ruby"; then
    install_rbenv_and_ruby
  fi

  # python and pyenv
  if is_enabled "python"; then
    install_pyenv_and_python
  fi

  # node/npm, and nvm
  if is_enabled "node"; then
    install_nvm_and_node
  fi

  # vim & tmux
  if is_enabled "vim_tmux"; then
    setup_vim_tmux_config
  fi

  # 1password and SSH agent
  if is_enabled "op"; then
    setup_1password
  fi

  # gemini CLI
  is_enabled "gemini_cli" && install_gemini_cli

  # claude
  is_enabled "claude_code_cli" && install_claude_code_cli

  # postman CLI
  is_enabled "postman_cli" && install_postman_cli

  # app store apps
  if is_macos && is_enabled "app_store"; then
    install_mas_apps
  fi

  echo -e "\n${GREEN}Dev setup completed successfully${NC}"
  if $RESTART_REQUIRED
  then
    echo -e "${YELLOW}You may need to restart your terminal${NC}"
  fi
  exit 0
fi
