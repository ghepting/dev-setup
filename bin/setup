#!/usr/bin/env zsh

# Check if we are running in zsh or bash
if [ -z "$ZSH_VERSION" ] && [ -z "$BASH_VERSION" ]; then
  echo -e "${RED}Error: This script must be run in zsh or bash.${NC}"
  return 1
fi

ZSHRC_FILE="$HOME/.zshrc"

# colors
RED="\e[31m"
GREEN="\e[32m"
YELLOW="\e[33m"
BLUE="\e[34m"
MAGENTA="\e[35m"
CYAN="\e[36m"
WHITE="\e[37m"
NC="\e[0m" # No Color (Reset)

RESTART_REQUIRED=false

# source utility functions
source "./lib/utils.sh"
source "./lib/brew.sh"
source "./lib/ruby.sh"
source "./lib/python.sh"
source "./lib/node.sh"
source "./lib/gemini.sh"
source "./lib/vim_tmux.sh"
source "./lib/1password.sh"
source "./lib/dotfiles.sh"
source "./lib/docker.sh"
source "./lib/app_store.sh"
source "./lib/claude.sh"
source "./lib/editor.sh"
source "./lib/iterm.sh"
source "./lib/postman.sh"

echo -e "${WHITE}Detected platform: ${PLATFORM}${NC}"

CONFIG_DIR="${HOME}/.config"
CONFIG_FILE="${CONFIG_DIR}/dev-setup.conf"

# create config directory if it doesn't exist
if [ ! -d "$CONFIG_DIR" ]
then
  mkdir -p "$CONFIG_DIR"
fi

# copy config file to ~/.config/dev-setup.conf if it doesn't exist
if [ ! -f "$CONFIG_FILE" ]
then
  cp "./dev-setup.conf" "$CONFIG_FILE"
  echo -e "${GREEN}Created default configuration at $CONFIG_FILE${NC}"
fi

echo -e "\n${YELLOW}--- Configuration Review ---${NC}"
echo -e "The setup will proceed with defaults based on your platform ($PLATFORM)."
echo -e "You can customize which modules are enabled in: ${WHITE}$CONFIG_FILE${NC}"
echo -e "${CYAN}Opening configuration in your editor now...${NC}"

# Open in editor and wait
${EDITOR:-vim} "$CONFIG_FILE"

echo -e "\n${GREEN}Configuration saved.${NC}"
echo -n "Press [Enter] to continue with the setup..."
read -r
echo -e "${YELLOW}----------------------------${NC}\n"
# initial setup
if is_macos; then
  # install homebrew
  install_homebrew
fi

# google drive setup
setup_google_drive

# google drive dotfiles
if is_enabled "dotfiles"; then
  symlink_google_drive_dotfiles
  symlink_antigravity_config
fi

if is_macos; then
  # add homebrew to path
  install_homebrew_path

  # add ghostty to path
  install_ghostty_path

  # homebrew and formulae
  install_homebrew_formulae

  # iTerm2 colors
  setup_iterm_colors
fi

# configure Antigravity as default editor
if is_enabled "editor"; then
  configure_editor
  install_antigravity_extensions
  update_antigravity_extensions_list
fi

# docker
if is_enabled "docker"; then
  setup_docker
fi

# ruby and rbenv
if is_enabled "ruby"; then
  install_rbenv_and_ruby
fi

# python and pyenv
if is_enabled "python"; then
  install_pyenv_and_python
fi

# node/npm, and nvm
if is_enabled "node"; then
  install_nvm_and_node
fi

# vim & tmux
if is_enabled "vim_tmux"; then
  setup_vim_tmux_config
fi

# 1password and SSH agent
if is_enabled "op"; then
  setup_1password
fi

# gemini CLI
install_gemini_cli

# claude
install_claude_code_cli

# postman CLI
install_postman_cli

# app store apps
if is_macos && is_enabled "app_store"; then
  install_mas_apps
fi

echo -e "${GREEN}Dev setup completed successfully${NC}"
if $RESTART_REQUIRED
then
  echo -e "${YELLOW}You may need to restart your terminal${NC}"
fi
exit 0
