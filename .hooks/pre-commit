#!/usr/bin/env zsh

# Pre-commit hook to check for trailing whitespace and formatting
# This script ensures that no trailing whitespace is committed and runs shfmt.

# Colors
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
NC='\033[0m'

echo -e "${YELLOW}Running pre-commit checks...${NC}"

# 1. Check for trailing whitespace
if git diff --cached --check | grep -q "trailing whitespace"; then
    echo -e "${RED}Error: Trailing whitespace detected.${NC}"
    git diff --cached --check
    echo -e "${YELLOW}Please fix the whitespace errors or use --no-verify.${NC}"
    exit 1
fi

# 2. Validate Zsh syntax
echo -e "${YELLOW}Validating Zsh syntax...${NC}"
# Find staged Zsh files (excluding .bats as they need the bats runner)
staged_zsh_files=(${(f)"$(git diff --cached --name-only --diff-filter=ACM | grep '\.sh$' 2>/dev/null)"})
staged_zsh_files=(${staged_zsh_files:#})

if [ ${#staged_zsh_files[@]} -gt 0 ]; then
    for f in "${staged_zsh_files[@]}"; do
        if ! zsh -n "$f"; then
            echo -e "${RED}Error: Syntax error in $f.${NC}"
            exit 1
        fi
    done
fi

echo -e "${GREEN}Pre-commit checks passed!${NC}"
exit 0
